<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>砖转转 拽 | 拽  砖专</title>
    <link rel="icon" type="image/png" href="logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Assistant', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        .list-view { display: flex; flex-direction: column; gap: 1rem; }
    </style>
</head>
<body class="bg-slate-50 font-['Assistant'] pb-20">
    <script>if(localStorage.getItem('user_auth') !== 'true') window.location.replace('login.html');</script>

    <header class="bg-white border-b-2 border-slate-200 p-4 sticky top-0 z-50 flex justify-between items-center text-right shadow-sm">
        <div class="flex items-center gap-4">
            <img src="logo.png" class="h-12">
            <h1 class="text-xl font-black text-slate-800">砖转转 拽专转</h1>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="toggleView()" class="p-2 bg-slate-100 rounded-xl hover:bg-slate-200 transition-all text-slate-600" title="祝 转爪">
                <svg id="viewIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                </svg>
            </button>
            <a href="index.html" class="p-2 bg-blue-100 rounded-xl text-blue-600 hover:bg-blue-200 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
            </a>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-6 text-right">
        <div class="mb-8 relative max-w-lg mx-auto">
            <input type="text" id="searchInput" onkeyup="filterSabbaths()" placeholder="驻砖 驻专砖  砖 拽..." class="w-full p-4 pr-12 rounded-2xl border-2 border-slate-200 focus:border-blue-500 outline-none shadow-sm font-bold transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 absolute right-4 top-4 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
        </div>

        <div id="sabbathContainer" class="list-view">
            <div class="text-center py-10 opacity-30 font-bold">注 专砖转 砖转转...</div>
        </div>
    </main>

    <div id="quickModal" class="fixed inset-0 z-[100] hidden bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl border-2 border-blue-100 text-right animate-in fade-in zoom-in duration-200">
            <h3 id="quickParasha" class="text-2xl font-black text-slate-800 mb-4 border-b pb-2 italic"></h3>
            <div id="quickContent" class="space-y-4"></div>
            <button onclick="closeQuick()" class="mt-6 w-full py-3 bg-slate-100 text-slate-500 font-bold rounded-xl hover:bg-slate-200 transition-all uppercase text-xs tracking-widest">住专</button>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        let allSabbaths = [];
        let db = [];
        let isGridView = false;

        async function init() {
            try {
                const res = await fetch(CONFIG.SCRIPT_URL);
                db = await res.json();
                await renderSabbaths();
            } catch(e) { console.error(e); }
        }

        async function renderSabbaths() {
            const container = document.getElementById('sabbathContainer');
            container.innerHTML = "";
            let sat = new Date(); 
            sat.setDate(sat.getDate() + (6 - sat.getDay()));

            for(let i=0; i<12; i++) {
                let d = new Date(sat); 
                d.setDate(sat.getDate() + (i*7));
                let dKey = d.toISOString().split('T')[0];
                
                const hRes = await fetch(`https://www.hebcal.com/converter?cfg=json&gy=${d.getFullYear()}&gm=${d.getMonth()+1}&gd=${d.getDate()}&g2h=1`);
                const hData = await hRes.json();

                let pName = "砖注";
                try {
                    const pRes = await fetch(`https://www.hebcal.com/hebcal?v=1&cfg=json&maj=on&year=${d.getFullYear()}&month=${d.getMonth()+1}`);
                    const pData = await pRes.json();
                    const item = pData.items.find(it => it.category === "parashat" && it.date === dKey);
                    pName = item ? item.hebrew : "砖注";
                } catch(e) {}

                // 爪转 砖爪 砖转  (拽专  -  砖转专 砖住  砖  砖砖 注专 砖转)
                //  砖 转 转 拽 转专 砖
                let friKey = new Date(d); friKey.setDate(d.getDate() - 1);
                let friKeyStr = friKey.toISOString().split('T')[0];
                let workers = db.filter(x => x.转专 === friKeyStr && (x.住_砖专转 === 'sat_morn' || x.住_砖专转 === 'sat_night'));
                
                const sabbathObj = { dKey, pName, hebrew: hData.hebrew, dateStr: d.toLocaleDateString('he-IL'), workers };
                allSabbaths.push(sabbathObj);
                appendSabbathToDOM(sabbathObj);
            }
        }

        function appendSabbathToDOM(s) {
            const container = document.getElementById('sabbathContainer');
            const card = document.createElement('div');
            card.className = "sabbath-item bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm flex flex-col md:flex-row justify-between items-center hover:border-blue-500 hover:shadow-md transition-all cursor-pointer group mb-2";
            card.setAttribute('data-search', `${s.pName} ${s.workers.map(w => w.砖_拽).join(' ')}`);
            
            card.innerHTML = `
                <div class="flex-1" onclick="window.location.href='index.html?jump=${s.dKey}'">
                    <div class="text-2xl font-black text-slate-800 group-hover:text-blue-600 transition-colors">砖转 驻专砖转 ${s.pName}</div>
                    <div class="text-blue-600 font-bold">${s.hebrew} | <span class="text-slate-400 font-medium text-sm">${s.dateStr}</span></div>
                </div>
                <div class="flex gap-2 mt-4 md:mt-0">
                    <button onclick="event.stopPropagation(); showQuick('${s.pName}', '${s.dKey}')" class="px-4 py-2 bg-slate-50 text-blue-600 rounded-xl font-bold text-sm border hover:bg-blue-600 hover:text-white transition-all">爪爪 专 </button>
                    <div class="bg-slate-50 p-3 rounded-full group-hover:bg-blue-600 group-hover:text-white transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </div>
                </div>
            `;
            container.appendChild(card);
        }

        function filterSabbaths() {
            const val = document.getElementById('searchInput').value.toLowerCase();
            document.querySelectorAll('.sabbath-item').forEach(item => {
                const searchData = item.getAttribute('data-search').toLowerCase();
                item.style.display = searchData.includes(val) ? (isGridView ? 'block' : 'flex') : 'none';
            });
        }

        function toggleView() {
            const container = document.getElementById('sabbathContainer');
            isGridView = !isGridView;
            container.className = isGridView ? "grid-view" : "list-view";
            
            // 注 拽
            document.getElementById('viewIcon').innerHTML = isGridView ? 
                `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />` : 
                `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />`;
            
            filterSabbaths();
        }

        function showQuick(parasha, dateKey) {
            document.getElementById('quickParasha').innerText = "驻专砖转 " + parasha;
            let fri = new Date(dateKey); fri.setDate(fri.getDate() - 1);
            let friStr = fri.toISOString().split('T')[0];
            
            // 住 砖爪 -DB
            const morn = db.filter(x => x.转专 === friStr && x.住_砖专转 === 'sat_morn');
            const night = db.filter(x => x.转专 === friStr && x.住_砖专转 === 'sat_night');

            let html = `
                <div class="space-y-2">
                    <div class="font-black text-blue-600 text-xs uppercase">砖转 拽专:</div>
                    ${morn.length ? morn.map(w => `<div class="bg-slate-50 p-2 rounded-lg font-bold">${w.砖_拽}</div>`).join('') : '<div class="text-slate-300 italic">专 砖爪</div>'}
                </div>
                <div class="space-y-2 mt-4">
                    <div class="font-black text-blue-600 text-xs uppercase">砖转 :</div>
                    ${night.length ? night.map(w => `<div class="bg-slate-50 p-2 rounded-lg font-bold">${w.砖_拽}</div>`).join('') : '<div class="text-slate-300 italic">专 砖爪</div>'}
                </div>
            `;
            document.getElementById('quickContent').innerHTML = html;
            document.getElementById('quickModal').classList.remove('hidden');
        }

        function closeQuick() { document.getElementById('quickModal').classList.add('hidden'); }

        init();
    </script>
</body>
</html>
